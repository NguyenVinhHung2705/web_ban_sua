{% load static %}
{% load formatters %}

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ p.product_name }} - MilkStore</title>
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
</head>
<body>

<!-- =========================
     HEADER
     ========================= -->
<header class="header">
  <div class="header-inner">
    <a class="logo" href="{% url 'dashboard' %}">
      <span class="logo-badge">M</span><span>MilkStore</span>
    </a>

    <div class="actions">
      <a class="btn secondary" href="{% url 'dashboard' %}">‚Üê Trang ch·ªß</a>

      <a class="cart" href="{% url 'to_view_cart' %}">
        üõí Gi·ªè h√†ng <span class="badge">{{ total_cart_item|default:0 }}</span>
      </a>

      {% if request.session.account_id %}
        <span class="chip">V√≠: <b>{{ balance|vnd }}</b></span>
        <a class="btn secondary" href="{% url 'my_orders' %}">ƒê∆°n h√†ng</a>
      {% else %}
        <a class="btn secondary" href="{% url 'to_login_page' %}">ƒêƒÉng nh·∫≠p</a>
        <a class="btn primary" href="{% url 'to_register_page' %}">ƒêƒÉng k√≠</a>
      {% endif %}
    </div>
  </div>
</header>

<main class="wrap">

  <div class="pd-card">
    <div class="pd-grid">

      <!-- =========================
           LEFT: GALLERY
           ========================= -->
      <div class="pd-gallery">

        <!-- Thumbnails -->
        <div class="pd-thumbs">
          {% if p.image %}
            <!-- ·∫¢nh ch√≠nh -->
            <button type="button" class="pd-thumb is-active" data-src="{{ p.image.url }}">
              <img src="{{ p.image.url }}" alt="{{ p.product_name }}">
            </button>
          {% endif %}

          {# ·∫¢nh ph·ª•: related_name="gallery" #}
          {% for g in p.gallery.all %}
            {% if g.image %}
              <button
                type="button"
                class="pd-thumb {% if not p.image and forloop.first %}is-active{% endif %}"
                data-src="{{ g.image.url }}"
              >
                <img src="{{ g.image.url }}" alt="{{ p.product_name }}">
              </button>
            {% endif %}
          {% endfor %}

          {# N·∫øu kh√¥ng c√≥ ·∫£nh ch√≠nh + kh√¥ng c√≥ ·∫£nh ph·ª• #}
          {% if not p.image and p.gallery.all|length == 0 %}
            <div class="muted" style="font-size:13px;">(Ch∆∞a c√≥ ·∫£nh)</div>
          {% endif %}
        </div>

        <!-- Main image -->
        <div class="pd-main">
          {% if p.image %}
            <img id="pdMainImg" src="{{ p.image.url }}" alt="{{ p.product_name }}">

          {% elif p.gallery.all|length > 0 and p.gallery.all.0.image %}
            {# Kh√¥ng c√≥ ·∫£nh ch√≠nh => l·∫•y ·∫£nh ph·ª• ƒë·∫ßu ti√™n l√†m ·∫£nh main #}
            <img id="pdMainImg" src="{{ p.gallery.all.0.image.url }}" alt="{{ p.product_name }}">

          {% else %}
            <div class="muted" style="height:260px; display:grid; place-items:center; border:1px dashed rgba(15,23,42,.18); border-radius:14px;">
              No image
            </div>
          {% endif %}
        </div>

      </div>

      <!-- =========================
           RIGHT: INFO
           ========================= -->
      <div class="pd-info">

        <!-- Category: tr√°nh l·ªói n·∫øu p.category null -->
        <div class="pd-cat">
          {% if p.category %}
            {{ p.category.category_name }}
          {% else %}
            (Ch∆∞a c√≥ danh m·ª•c)
          {% endif %}
        </div>

        <h1 class="pd-title">{{ p.product_name }}</h1>

        <div class="pd-price-row">
          <div class="pd-price">{{ p.price|vnd }}</div>

          <!-- Badges -->
          <div class="pd-badges">
            {% if p.is_genuine %}<span class="pd-badge">‚úÖ Ch√≠nh h√£ng</span>{% endif %}
            {% if p.is_fast_ship %}<span class="pd-badge">üöö Giao nhanh</span>{% endif %}
          </div>
        </div>

        <!-- Short description -->
        <div class="pd-short">
          {{ p.description|default:"S·∫£n ph·∫©m ch√≠nh h√£ng, ph√π h·ª£p cho b√© v√† gia ƒë√¨nh. H·ªó tr·ª£ ƒë·ªïi tr·∫£ 7 ng√†y." }}
        </div>

        <!-- Actions -->
        <div class="pd-actions">
          {% if request.session.account_id %}

            {# Add to cart n√™n POST ƒë·ªÉ ƒë√∫ng chu·∫©n #}
            <form method="post" action="{% url 'add_to_cart' p.product_id %}" style="display:inline;">
              {% csrf_token %}
              <button class="btn primary" type="submit">Th√™m v√†o gi·ªè</button>
            </form>

            <a class="btn secondary" href="{% url 'checkout' %}">Mua ngay</a>

          {% else %}
            <a class="btn primary" href="{% url 'to_login_page' %}">ƒêƒÉng nh·∫≠p ƒë·ªÉ mua</a>
          {% endif %}
        </div>

        <!-- Meta -->
        <div class="pd-meta">
          <div class="pd-meta-item">
            <div class="muted">G·ª£i √Ω</div>
            <b>{{ p.hint_text|default:"U·ªëng ngon h∆°n khi l·∫°nh" }}</b>
          </div>
          <div class="pd-meta-item">
            <div class="muted">B·∫£o qu·∫£n</div>
            <b>{{ p.storage_short|default:"N∆°i kh√¥ r√°o, tho√°ng m√°t" }}</b>
          </div>
          <div class="pd-meta-item">
            <div class="muted">ƒê·ªïi tr·∫£</div>
            <b>{{ p.return_policy|default:"7 ng√†y n·∫øu l·ªói" }}</b>
          </div>
        </div>

      </div>
    </div>

    <!-- =========================
         DETAILS
         ========================= -->
    <div class="pd-divider"></div>

    <div class="pd-detail-grid">

      <div class="pd-block">
        <h3>M√¥ t·∫£ s·∫£n ph·∫©m</h3>
        <p class="muted" style="line-height:1.7; margin:0;">
          {{ p.description|default:"S·∫£n ph·∫©m s·ªØa ch√≠nh h√£ng, ƒë·∫ßy ƒë·ªß dinh d∆∞·ª°ng. Ph√π h·ª£p nhi·ªÅu ƒë·ªëi t∆∞·ª£ng s·ª≠ d·ª•ng." }}
        </p>
      </div>

      <div class="pd-block">
        <h3>H∆∞·ªõng d·∫´n b·∫£o qu·∫£n</h3>
        <div class="pd-list muted" style="line-height:1.7;">
          {{ p.storage_guide|default:"B·∫£o qu·∫£n n∆°i kh√¥ r√°o v√† tho√°ng m√°t.\nƒê√≥ng k√≠n sau khi m·ªü.\nNgon h∆°n khi u·ªëng l·∫°nh."|linebreaksbr }}
        </div>
      </div>

      <div class="pd-block">
        <h3>Th√¥ng tin dinh d∆∞·ª°ng</h3>
        <div class="pd-nutri">
          <div><span class="muted">NƒÉng l∆∞·ª£ng</span><b>{{ p.energy_kcal|default:0 }} kcal</b></div>
          <div><span class="muted">Ch·∫•t ƒë·∫°m</span><b>{{ p.protein_g|floatformat:1 }} g</b></div>
          <div><span class="muted">Ch·∫•t b√©o</span><b>{{ p.fat_g|floatformat:1 }} g</b></div>
          <div><span class="muted">Carb</span><b>{{ p.carb_g|floatformat:1 }} g</b></div>
        </div>
      </div>

    </div>
  </div>

  <!-- =========================
       RELATED PRODUCTS
       ========================= -->
  <section class="section">
    <div class="section-head">
      <h2>S·∫£n ph·∫©m li√™n quan</h2>
      <span class="muted">C√πng danh m·ª•c</span>
    </div>

    <div class="product-grid">
      {% for rp in related %}
        <div class="product-card">

          <a class="product-img" href="{% url 'product_detail' rp.product_id %}">
            {% if rp.image %}
              <img src="{{ rp.image.url }}" alt="{{ rp.product_name }}">
            {% else %}
              <div class="muted" style="display:grid;place-items:center;height:100%;">No image</div>
            {% endif %}
          </a>

          <a class="product-name" href="{% url 'product_detail' rp.product_id %}">
            {{ rp.product_name }}
          </a>

          <div class="product-meta">
            <div class="product-price">{{ rp.price|vnd }}</div>

            <!-- related category: c≈©ng n√™n check null -->
            <div class="product-cat">
              {% if rp.category %}{{ rp.category.category_name }}{% else %}(Ch∆∞a c√≥){% endif %}
            </div>
          </div>

          {% if rp.description %}
            <div class="product-desc">{{ rp.description }}</div>
          {% endif %}

          {% if request.session.account_id %}
            <form method="post" action="{% url 'add_to_cart' rp.product_id %}">
              {% csrf_token %}
              <button class="btn primary product-btn" type="submit">Th√™m v√†o gi·ªè</button>
            </form>
          {% else %}
            <a class="btn secondary product-btn" href="{% url 'to_login_page' %}">ƒêƒÉng nh·∫≠p ƒë·ªÉ mua</a>
          {% endif %}

        </div>
      {% empty %}
        <p class="muted">Ch∆∞a c√≥ s·∫£n ph·∫©m li√™n quan.</p>
      {% endfor %}
    </div>
  </section>

</main>

<!-- =========================
     JS: click thumb ƒë·ªïi ·∫£nh main
     ========================= -->
<script>
  const mainImg = document.getElementById("pdMainImg");

  document.querySelectorAll(".pd-thumb").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".pd-thumb").forEach(b => b.classList.remove("is-active"));
      btn.classList.add("is-active");

      const src = btn.getAttribute("data-src");
      if (src && mainImg) mainImg.src = src;
    });
  });
</script>

</body>
</html>
