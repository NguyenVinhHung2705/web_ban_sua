{% load static %}
{% load formatters %}

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - S·∫£n ph·∫©m</title>
  <link rel="stylesheet" href="{% static 'css/admin_page.css' %}">
</head>
<body>

<div class="container">

  <!-- ===== TOP BAR ===== -->
  <div class="topbar">
    <div class="brand">
      <a href="{% url 'to_admin_page' %}">‚Üê Admin</a>
    </div>

    <div class="muted">
      {% if account %}
        Xin ch√†o <b>{{ account.username }}</b>
      {% endif %}
    </div>
  </div>

  <div class="page-card">

    <!-- ===== PAGE HEADER ===== -->
    <div class="page-head">
      <div>
        <h1>Qu·∫£n l√Ω s·∫£n ph·∫©m</h1>
        <div class="muted">Danh s√°ch s·∫£n ph·∫©m ‚Ä¢ S·ª≠a/x√≥a nhanh ‚Ä¢ T√¨m ki·∫øm/ l·ªçc</div>
      </div>

      <a class="btn primary" href="{% url 'admin_product_create' %}">+ Th√™m s·∫£n ph·∫©m</a>
    </div>

    <!-- ===== TOOLBAR: SEARCH / FILTER / SORT ===== -->
    <form class="toolbar" method="get">
      <!-- T√¨m ki·∫øm theo t√™n -->
      <div class="tool">
        <label for="q">T√¨m</label>
        <input id="q" type="text" name="q" value="{{ q|default_if_none:'' }}" placeholder="T√™n s·∫£n ph·∫©m...">
      </div>

      <!-- L·ªçc theo danh m·ª•c -->
      <div class="tool">
        <label for="cat">Danh m·ª•c</label>
        <select id="cat" name="cat">
          <option value="">-- T·∫•t c·∫£ --</option>
          {% for c in categories %}
            {# cat t·ª´ querystring l√† string => so s√°nh b·∫±ng stringformat:"s" #}
            <option value="{{ c.category_id }}" {% if cat == c.category_id|stringformat:"s" %}selected{% endif %}>
              {{ c.category_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- S·∫Øp x·∫øp -->
      <div class="tool">
        <label for="sort">S·∫Øp x·∫øp</label>
        <select id="sort" name="sort">
          <option value="new" {% if sort == "new" %}selected{% endif %}>M·ªõi nh·∫•t</option>
          <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>Gi√° tƒÉng</option>
          <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Gi√° gi·∫£m</option>
        </select>
      </div>

      <!-- N√∫t l·ªçc / reset -->
      <div class="tool tool-actions">
        <button class="btn secondary" type="submit">L·ªçc</button>
        <a class="btn ghost" href="{% url 'admin_products' %}">Reset</a>
      </div>
    </form>

    <!-- ===== TABLE WRAP ===== -->
    <div class="table-wrap">
      <div class="table-head">
        <div class="table-title">
          <span class="dot"></span>
          <b>Danh s√°ch</b>
        </div>

        <!-- T·ªïng s·ªë b·∫£n ghi d·ª±a theo paginator -->
        <span class="pill">T·ªïng: {{ page_obj.paginator.count }}</span>
      </div>

      {% if page_obj %}
        <table>
          <thead>
            <tr>
              <th style="width:72px;">·∫¢nh</th>
              <th>S·∫£n ph·∫©m</th>
              <th>Danh m·ª•c</th>
              <th class="right">Gi√°</th>
              <th class="center">Badge</th>
              <th class="right" style="width:220px;">Thao t√°c</th>
            </tr>
          </thead>

          <tbody>
            {% for p in page_obj %}
              <tr>
                <!-- ·∫¢nh -->
                <td>
                  <div class="thumb">
                    {% if p.image %}
                      <img src="{{ p.image.url }}" alt="{{ p.product_name }}">
                    {% else %}
                      <div class="thumb-empty">No</div>
                    {% endif %}
                  </div>
                </td>

                <!-- T√™n + ID -->
                <td>
                  <div style="font-weight:900;">{{ p.product_name }}</div>
                  <div class="muted" style="font-size:12px;">#{{ p.product_id }}</div>
                </td>

                <!-- Danh m·ª•c: tr√°nh l·ªói n·∫øu p.category null -->
                <td class="muted">
                  {% if p.category %}
                    {{ p.category.category_name }}
                  {% else %}
                    (Ch∆∞a c√≥)
                  {% endif %}
                </td>

                <!-- Gi√°: format vnd (filter custom) -->
                <td class="right">
                  <b>{{ p.price|vnd }}</b>
                </td>

                <!-- Badge -->
                <td class="center">
                  <div class="badge-row">
                    {% if p.is_genuine %}
                      <span class="tag ok">‚úÖ Ch√≠nh h√£ng</span>
                    {% endif %}

                    {% if p.is_fast_ship %}
                      <span class="tag ship">üöö Giao nhanh</span>
                    {% endif %}

                    {% if not p.is_genuine and not p.is_fast_ship %}
                      <span class="tag">‚Äî</span>
                    {% endif %}
                  </div>
                </td>

                <!-- Thao t√°c: S·ª≠a + X√≥a (POST + CSRF) -->
                <td class="right">
                  <a class="btn secondary" href="{% url 'admin_product_edit' p.product_id %}">S·ª≠a</a>

                  <form
                    method="post"
                    action="{% url 'admin_product_delete' p.product_id %}"
                    style="display:inline;"
                    onsubmit="return confirm('X√≥a s·∫£n ph·∫©m n√†y?');"
                  >
                    {% csrf_token %}
                    <button class="btn danger" type="submit">X√≥a</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- ===== PAGINATION ===== -->
        <div class="pager">
          {% if page_obj.has_previous %}
            <a class="btn ghost"
               href="?q={{ q|urlencode }}&cat={{ cat|urlencode }}&sort={{ sort|urlencode }}&page={{ page_obj.previous_page_number }}">
              ‚Üê Tr∆∞·ªõc
            </a>
          {% else %}
            <span></span>
          {% endif %}

          <div class="muted">
            Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
          </div>

          {% if page_obj.has_next %}
            <a class="btn ghost"
               href="?q={{ q|urlencode }}&cat={{ cat|urlencode }}&sort={{ sort|urlencode }}&page={{ page_obj.next_page_number }}">
              Sau ‚Üí
            </a>
          {% else %}
            <span></span>
          {% endif %}
        </div>

      {% else %}
        <div class="card">
          <div class="muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.</div>
        </div>
      {% endif %}
    </div>

  </div>
</div>

</body>
</html>
