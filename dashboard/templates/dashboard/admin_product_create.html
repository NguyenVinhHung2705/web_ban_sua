{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Thêm sản phẩm</title>
  <link rel="stylesheet" href="{% static 'css/admin_page.css' %}">
</head>
<body>

<div class="container">

  <!-- ===== TOP BAR ===== -->
  <div class="topbar">
    <div class="brand">
      <a href="{% url 'admin_products' %}">← Sản phẩm</a>
    </div>
    <div class="muted">
      Xin chào <b>{{ account.username }}</b>
    </div>
  </div>

  <div class="page-card">
    <h1>Thêm sản phẩm</h1>

    <!-- Thông báo lỗi nếu view truyền error_message -->
    {% if error_message %}
      <div class="alert">{{ error_message }}</div>
    {% endif %}

    <!-- enctype multipart để upload ảnh -->
    <form method="post" enctype="multipart/form-data" class="form-card" autocomplete="off">
      {% csrf_token %}

      <!-- ===== GRID 1: name / price / category / main image ===== -->
      <div class="form-grid">

        <div class="field">
          <label for="product_name">Tên sản phẩm</label>
          <input id="product_name" type="text" name="product_name" required>
        </div>

        <div class="field">
          <label for="price">Giá</label>
          <input id="price" type="number" step="0.01" name="price" inputmode="decimal" required>
        </div>

        <div class="field">
          <label for="category_id">Danh mục</label>
          <select id="category_id" name="category_id" required>
            <option value="">-- Chọn danh mục --</option>
            {% for c in categories %}
              <option value="{{ c.category_id }}">{{ c.category_name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- ===== MAIN IMAGE (preview) ===== -->
        <div class="field">
          <label for="mainImgInput">Ảnh chính</label>

          <!-- Khu preview: mặc định show hint, khi chọn ảnh thì show img -->
          <div class="img-preview-wrap" style="margin-bottom:10px;">
            <img id="mainImgPreview" class="img-preview" style="display:none;" alt="main preview">
            <div id="mainImgHint" class="muted" style="font-size:12px;">Chưa chọn ảnh</div>
          </div>

          <input id="mainImgInput" type="file" name="image" accept="image/*">
          <div class="muted" style="font-size:12px;">Chọn ảnh sẽ hiển thị preview ngay</div>
        </div>

      </div>

      <!-- ===== DESCRIPTION ===== -->
      <div class="field">
        <label for="description">Mô tả</label>
        <textarea id="description" name="description" rows="3" placeholder="Mô tả ngắn..."></textarea>
      </div>

      <div class="hr"></div>

      <!-- ===== GRID 2: badges + gallery ===== -->
      <div class="form-grid">

        <div class="field">
          <label>Badge</label>
          <div class="check-row">
            <!-- Checkbox: nếu muốn mặc định checked thì để checked -->
            <label><input type="checkbox" name="is_genuine" checked> Chính hãng</label>
            <label><input type="checkbox" name="is_fast_ship" checked> Giao nhanh</label>
          </div>
        </div>

        <!-- ===== GALLERY (multiple preview) ===== -->
        <div class="field">
          <label for="galleryInput">Ảnh phụ (gallery)</label>
          <input id="galleryInput" type="file" name="gallery_images" accept="image/*" multiple>

          <!-- Box hiển thị nhiều ảnh preview -->
          <div id="galleryPreview" class="gallery-preview" style="display:none;"></div>

          <div class="muted" style="font-size:12px;">Giữ Ctrl để chọn nhiều ảnh (preview sẽ hiện bên dưới)</div>
        </div>

      </div>

      <!-- ===== GRID 3: hint / storage short / return policy ===== -->
      <div class="form-grid">
        <div class="field">
          <label for="hint_text">Gợi ý</label>
          <input id="hint_text" type="text" name="hint_text" placeholder="Uống ngon hơn khi lạnh">
        </div>

        <div class="field">
          <label for="storage_short">Bảo quản (ngắn)</label>
          <input id="storage_short" type="text" name="storage_short" placeholder="Nơi khô ráo, thoáng mát">
        </div>

        <div class="field">
          <label for="return_policy">Đổi trả</label>
          <input id="return_policy" type="text" name="return_policy" placeholder="7 ngày nếu lỗi">
        </div>
      </div>

      <!-- ===== STORAGE GUIDE ===== -->
      <div class="field">
        <label for="storage_guide">Hướng dẫn bảo quản (mỗi dòng 1 gạch đầu dòng)</label>
        <textarea id="storage_guide" name="storage_guide" rows="4">Bảo quản nơi khô ráo và thoáng mát.
Đóng kín sau khi mở.
Ngon hơn khi uống lạnh.</textarea>
      </div>

      <!-- ===== NUTRITION ===== -->
      <div class="form-grid">
        <div class="field">
          <label for="energy_kcal">Năng lượng (kcal)</label>
          <input id="energy_kcal" type="number" name="energy_kcal" value="60">
        </div>

        <div class="field">
          <label for="protein_g">Protein (g)</label>
          <input id="protein_g" type="number" step="0.1" name="protein_g" value="3.0" inputmode="decimal">
        </div>

        <div class="field">
          <label for="fat_g">Fat (g)</label>
          <input id="fat_g" type="number" step="0.1" name="fat_g" value="3.0" inputmode="decimal">
        </div>

        <div class="field">
          <label for="carb_g">Carb (g)</label>
          <input id="carb_g" type="number" step="0.1" name="carb_g" value="4.0" inputmode="decimal">
        </div>
      </div>

      <!-- ===== ACTIONS ===== -->
      <div class="form-actions">
        <button class="btn primary" type="submit">Lưu</button>
        <a class="btn secondary" href="{% url 'admin_products' %}">Hủy</a>
      </div>

    </form>
  </div>
</div>

<script>
  // =========================
  // MAIN IMAGE PREVIEW (1 ảnh)
  // =========================
  (function () {
    const input = document.getElementById("mainImgInput");
    const preview = document.getElementById("mainImgPreview");
    const hint = document.getElementById("mainImgHint");
    if (!input || !preview) return;

    let currentUrl = null;

    input.addEventListener("change", () => {
      const file = input.files && input.files[0];

      // Nếu bỏ chọn ảnh
      if (!file) {
        if (currentUrl) URL.revokeObjectURL(currentUrl);
        currentUrl = null;
        preview.style.display = "none";
        if (hint) hint.style.display = "block";
        return;
      }

      // Hủy URL cũ để tránh leak bộ nhớ
      if (currentUrl) URL.revokeObjectURL(currentUrl);

      currentUrl = URL.createObjectURL(file);
      preview.src = currentUrl;
      preview.style.display = "block";
      if (hint) hint.style.display = "none";
    });
  })();

  // =========================
  // GALLERY PREVIEW (nhiều ảnh)
  // =========================
  (function () {
    const input = document.getElementById("galleryInput");
    const box = document.getElementById("galleryPreview");
    if (!input || !box) return;

    // Lưu URL để revoke sau mỗi lần chọn lại
    let urls = [];

    input.addEventListener("change", () => {
      // Dọn preview cũ + revoke url cũ
      urls.forEach(u => URL.revokeObjectURL(u));
      urls = [];
      box.innerHTML = "";

      const files = Array.from(input.files || []);
      if (!files.length) {
        box.style.display = "none";
        return;
      }

      files.forEach(file => {
        const url = URL.createObjectURL(file);
        urls.push(url);

        const img = document.createElement("img");
        img.src = url;
        img.alt = "gallery preview";
        box.appendChild(img);
      });

      box.style.display = "grid";
    });
  })();
</script>

</body>
</html>
