{% load static %}
{% load formatters %}

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MilkStore</title>
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
</head>

<body>

  <!-- =========================
       HEADER
       ========================= -->
  <header class="header">
    <div class="header-inner">

      <!-- Logo -->
      <a class="logo" href="{% url 'dashboard' %}">
        <span class="logo-badge">M</span>
        <span>MilkStore</span>
      </a>

      <!-- ===== SEARCH FORM (GET) ===== -->
      <form class="search" action="{% url 'dashboard' %}" method="get">
        <label for="q" class="sr-only">T√¨m ki·∫øm</label>
        <input
          id="q"
          type="text"
          name="q"
          value="{{ q|default:'' }}"
          placeholder="T√¨m s·ªØa, b·ªâm, vitamin..."
        />

        {# N·∫øu ƒëang l·ªçc theo category th√¨ gi·ªØ cat khi search #}
        {% if active_cat %}
          <input type="hidden" name="cat" value="{{ active_cat }}">
        {% endif %}

        <button class="chip" type="submit">T√¨m</button>
      </form>

      <!-- ===== ACTIONS RIGHT ===== -->
      <div class="actions">

        <!-- Admin shortcut -->
        {% if account and account.role == "ADMIN" %}
          <a class="btn secondary" href="{% url 'to_admin_page' %}">Admin</a>
        {% endif %}

        <!-- Cart -->
        <a class="cart" href="{% url 'to_view_cart' %}">
          üõí Gi·ªè h√†ng
          <span class="badge">{{ total_cart_item|default:0 }}</span>
        </a>

        <!-- Auth / User menu -->
        {% if not request.session.account_id %}
          <a class="btn secondary" href="{% url 'to_login_page' %}">ƒêƒÉng nh·∫≠p</a>
          <a class="btn primary" href="{% url 'to_register_page' %}">ƒêƒÉng k√≠</a>
        {% else %}
          <!-- V√≠ hi·ªÉn th·ªã nhanh -->
          <span class="chip">V√≠: <b>{{ balance|vnd }}</b></span>

          <!-- User dropdown (UI) -->
          <div class="user-menu">
            <button class="user-btn" type="button" aria-label="T√†i kho·∫£n">üë§</button>

            <div class="user-dropdown">
              <div class="ud-title">{{ account.username }}</div>
              <div class="ud-item"><span>Vai tr√≤</span><b>{{ account.role }}</b></div>
              <div class="ud-item"><span>S·ªë d∆∞</span><b>{{ balance|vnd }}</b></div>
            </div>
          </div>

          <!-- C√°c n√∫t nhanh (b·∫°n ƒëang hi·ªÉn th·ªã c·∫£ dropdown + n√∫t nhanh, gi·ªØ nguy√™n) -->
          <a class="btn secondary" href="{% url 'wallet_topup' %}">N·∫°p v√≠</a>
          <a class="btn secondary" href="{% url 'my_orders' %}">ƒê∆°n h√†ng</a>
          <a class="btn secondary" href="{% url 'logout' %}">ƒêƒÉng xu·∫•t</a>
        {% endif %}
      </div>
    </div>

    <!-- =========================
         CATEGORY BAR
         ========================= -->
    <nav class="catbar">
      <div class="catbar-inner">

        {# Link "T·∫•t c·∫£": n·∫øu ƒëang c√≥ q th√¨ gi·ªØ q #}
        <a
          class="catlink {% if not active_cat %}active{% endif %}"
          href="{% url 'dashboard' %}{% if q %}?q={{ q|urlencode }}{% endif %}#products"
        >
          T·∫•t c·∫£
        </a>

        {% for c in nav_categories %}
          {# active_cat c√≥ th·ªÉ l√† string t·ª´ query => so s√°nh b·∫±ng stringformat:"s" ƒë·ªÉ ch·∫Øc #}
          <a
            class="catlink {% if active_cat|stringformat:'s' == c.category_id|stringformat:'s' %}active{% endif %}"
            href="{% url 'dashboard' %}?cat={{ c.category_id }}{% if q %}&q={{ q|urlencode }}{% endif %}#products"
          >
            {{ c.category_name }}
          </a>
        {% endfor %}

      </div>
    </nav>
  </header>

  <!-- =========================
       BANNER
       Ch·ªâ hi·ªán khi: kh√¥ng ch·ªçn category + kh√¥ng search
       ========================= -->
  {% if not active_cat and not q %}
    <section class="hero-band">
      <div class="hero-banner full">
        <img src="{% static 'img/banner_th_1920.webp' %}" alt="MilkStore banner">
      </div>
    </section>
  {% endif %}

  <!-- =========================
       MAIN
       ========================= -->
  <main class="wrap">

    <!-- ===== PRODUCTS SECTION ===== -->
    <section class="section" id="products">
      <div class="section-head">

        {% if q %}
          <h2>K·∫øt qu·∫£ t√¨m ki·∫øm: ‚Äú{{ q }}‚Äù</h2>
          <span class="muted">T√¨m th·∫•y {{ search_count }} s·∫£n ph·∫©m</span>

        {% elif active_cat %}
          <h2>
            Danh m·ª•c:
            {# N·∫øu categories c√≥ list ƒë·∫ßy ƒë·ªß, t√¨m t√™n danh m·ª•c theo active_cat #}
            {% for c in categories %}
              {% if c.category_id|stringformat:'s' == active_cat|stringformat:'s' %}
                {{ c.category_name }}
              {% endif %}
            {% endfor %}
          </h2>
          <span class="muted">Gi√° t·ªët ‚Äì ch√≠nh h√£ng</span>

        {% else %}
          <h2>S·∫£n ph·∫©m n·ªïi b·∫≠t</h2>
          <span class="muted">Gi√° t·ªët ‚Äì ch√≠nh h√£ng</span>
        {% endif %}

      </div>

      <!-- Grid: trang ch·ªß 4 c·ªôt | khi l·ªçc/search th√¨ 3 c·ªôt -->
      <div class="product-grid {% if active_cat or q %}grid-3{% endif %}">

        {% for p in products %}
          <article class="product-card pro">

            <!-- ·∫¢nh + link chi ti·∫øt -->
            <a class="product-img" href="{% url 'product_detail' p.product_id %}">
              {% if p.image %}
                <img src="{{ p.image.url }}" alt="{{ p.product_name }}">
              {% else %}
                <img src="{% static 'img/placeholder.png' %}" alt="{{ p.product_name }}">
              {% endif %}
            </a>

            <!-- Danh m·ª•c: tr√°nh l·ªói n·∫øu p.category null -->
            <div class="p-badge">
              {% if p.category %}
                {{ p.category.category_name }}
              {% else %}
                Ch∆∞a ph√¢n lo·∫°i
              {% endif %}
            </div>

            <!-- T√™n -->
            <div class="product-name">
              <a href="{% url 'product_detail' p.product_id %}">{{ p.product_name }}</a>
            </div>

            <!-- Gi√° -->
            <div class="p-price">{{ p.price|vnd }}</div>

            <!-- M√¥ t·∫£ ng·∫Øn (n·∫øu c√≥) -->
            {% if p.description %}
              <div class="product-desc">{{ p.description }}</div>
            {% endif %}

            <!-- Add to cart: POST + CSRF -->
            <form method="post" action="{% url 'add_to_cart' p.product_id %}">
              {% csrf_token %}
              <button class="btn primary product-btn" type="submit">Th√™m v√†o gi·ªè</button>
            </form>

          </article>

        {% empty %}
          <div class="muted">Kh√¥ng c√≥ s·∫£n ph·∫©m ph√π h·ª£p.</div>
        {% endfor %}

      </div>

      <!-- ===== PAGINATION (ngo√†i v√≤ng for) ===== -->
      {% if page_obj and page_obj.paginator.num_pages > 1 %}
        <div class="pager">

          {% if page_obj.has_previous %}
            <a class="btn secondary"
               href="?page={{ page_obj.previous_page_number }}{% if active_cat %}&cat={{ active_cat }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}#products">
              ‚Üê Tr∆∞·ªõc
            </a>
          {% endif %}

          <span class="chip">
            Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
            <a class="btn secondary"
               href="?page={{ page_obj.next_page_number }}{% if active_cat %}&cat={{ active_cat }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}#products">
              Sau ‚Üí
            </a>
          {% endif %}

        </div>
      {% endif %}
    </section>

    <!-- ===== TRUST SECTION ===== -->
    <section class="grid trust-bottom">
      <div class="card">
        <h3 class="card-title">‚úÖ H√†ng ch√≠nh h√£ng</h3>
        <p class="card-sub">Cam k·∫øt ngu·ªìn g·ªëc r√µ r√†ng, h·∫°n d√πng minh b·∫°ch.</p>
      </div>
      <div class="card">
        <h3 class="card-title">üöö Giao nhanh</h3>
        <p class="card-sub">Giao n·ªôi th√†nh nhanh, theo d√µi ƒë∆°n d·ªÖ d√†ng.</p>
      </div>
      <div class="card">
        <h3 class="card-title">üí≥ Thanh to√°n an to√†n</h3>
        <p class="card-sub">H·ªó tr·ª£ nhi·ªÅu ph∆∞∆°ng th·ª©c, b·∫£o m·∫≠t th√¥ng tin.</p>
      </div>
    </section>

  </main>

</body>
</html>
