{% load static %}
{% load tz %}
{% load formatters %}

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trang quản trị</title>
  <link rel="stylesheet" href="{% static 'css/admin_page.css' %}">
</head>

<body>
  <div class="container">

    <!-- ===== TOP BAR ===== -->
    <div class="topbar">
      <div class="brand">
        <!-- Quay lại dashboard/trang chủ -->
        <a href="{% url 'dashboard' %}">← Trang chủ</a>
      </div>

      <div class="muted">
        <!-- account có thể null => check trước -->
        {% if account %}
          Xin chào <b>{{ account.username }}</b>
        {% endif %}
      </div>
    </div>

    <h1>Trang quản trị</h1>

    <!-- ===== TAB BUTTONS ===== -->
    <div class="tabs">
      <!-- active mặc định cho tab users -->
      <button class="tab-btn active" type="button" onclick="openTab(event, 'users')">Quản lý người dùng</button>
      <button class="tab-btn" type="button" onclick="openTab(event, 'products')">Quản lý sản phẩm</button>
      <button class="tab-btn" type="button" onclick="openTab(event, 'categories')">Quản lý danh mục</button>
      <button class="tab-btn" type="button" onclick="openTab(event, 'orders')">Quản lý đơn hàng</button>
    </div>

    <!-- =========================
         TAB: USERS
         ========================= -->
    <div id="users" class="tab-content active">
      <div class="section-head">
        <div>
          <h2>Quản lý người dùng</h2>
          <p class="muted">Trang riêng có search / phân trang / sửa / khóa / xóa.</p>
        </div>

        <!-- Nhóm nút hành động -->
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn secondary" href="{% url 'admin_users' %}">Xem danh sách</a>
          <a class="btn primary" href="{% url 'admin_user_create' %}">+ Thêm người dùng</a>
        </div>
      </div>
    </div>

    <!-- =========================
         TAB: PRODUCTS
         ========================= -->
    <div id="products" class="tab-content">
      <div class="section-head">
        <div>
          <h2>Quản lý sản phẩm</h2>
          <p class="muted">Trang riêng có search / filter / phân trang / sửa / xóa.</p>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn primary" href="{% url 'admin_products' %}">Mở danh sách sản phẩm</a>
        </div>
      </div>
    </div>

    <!-- =========================
         TAB: CATEGORIES
         ========================= -->
    <div id="categories" class="tab-content">
      <div class="section-head">
        <div>
          <h2>Quản lý danh mục</h2>
          <p class="muted">Bạn cần tạo Category trước để thêm Product.</p>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn secondary" href="{% url 'admin_categories' %}">Xem danh sách</a>
          <a class="btn primary" href="{% url 'admin_category_create' %}">+ Thêm danh mục</a>
        </div>
      </div>

      <!-- Danh mục gần đây (nếu view truyền recent_categories) -->
      {% if recent_categories %}
        <div class="muted" style="margin-top:12px;">
          Gần đây ({{ recent_categories|length }} danh mục):
        </div>

        <div style="margin-top:10px; display:grid; gap:12px;">
          {% for c in recent_categories %}
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
              <div>
                <div style="font-weight:900;">{{ c.category_name }}</div>
                <div class="muted" style="font-size:13px;">ID: {{ c.category_id }}</div>
              </div>

              <div style="display:flex; gap:10px;">
                <!-- Sửa -->
                <a class="btn secondary" href="{% url 'admin_category_edit' c.category_id %}">Sửa</a>

                <!-- Xóa: POST + CSRF -->
                <form method="post" action="{% url 'admin_category_delete' c.category_id %}" style="margin:0;">
                  {% csrf_token %}
                  <button class="btn" type="submit" onclick="return confirm('Xóa danh mục này?')">Xóa</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="muted" style="margin-top:10px; font-size:13px;">
          (Hiển thị danh mục gần đây. Bấm “Xem danh sách” để xem đầy đủ.)
        </div>
      {% endif %}
    </div>

    <!-- =========================
         TAB: ORDERS
         ========================= -->
    <div id="orders" class="tab-content">
      <div class="section-head">
        <div>
          <h2>Quản lý đơn hàng</h2>
          <p class="muted">Trang riêng có danh sách + chi tiết + cập nhật trạng thái.</p>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn secondary" href="{% url 'admin_orders' %}">Xem danh sách</a>
        </div>
      </div>

      <!-- Đơn gần đây (nếu view truyền recent_orders) -->
      {% if recent_orders %}
        <div class="muted" style="margin-top:12px;">
          Gần đây ({{ recent_orders|length }} đơn):
        </div>

        <div style="margin-top:10px; display:grid; gap:12px;">
          {% for o in recent_orders %}
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
              <div>
                <div style="font-weight:900;">Đơn #{{ o.order_id }}</div>

                <!-- vnd: filter custom để format tiền -->
                <div class="muted" style="font-size:13px;">
                  {{ o.account.username }} • {{ o.status }} • {{ o.total_amount|vnd }}
                </div>
              </div>

              <a class="btn secondary" href="{% url 'admin_order_detail' o.order_id %}">Chi tiết</a>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

  </div>

  <script>
    // Chuyển tab: ẩn toàn bộ tab-content và bỏ active của toàn bộ tab-btn,
    // sau đó bật active cho tab được chọn.
    function openTab(e, tabId) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
      document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));

      const target = document.getElementById(tabId);
      if (!target) return;

      target.classList.add("active");
      e.currentTarget.classList.add("active");
    }
  </script>
</body>
</html>
